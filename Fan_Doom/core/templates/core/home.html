{% extends 'core/base.html' %}
{% load static %}

{% block title %}Fan_Doom - Home{% endblock %}

{% block content %}
    <div class="container" style="display:flex;gap:2rem;max-width:1200px;margin:2rem auto;align-items:flex-start;">
        <!-- Autores a seguir -->
        <aside style="flex:0 0 220px;background:#fff;border-radius:14px;box-shadow:0 2px 8px #0001;padding:1.2rem 1rem;min-height:300px;">
            <h3 style="margin-bottom:1rem;font-size:1.1rem;color:#23272d;">Autores a seguir</h3>
            <div style="display:flex;flex-direction:column;gap:0.7rem;">
                {% for author in authors %}
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;" class="author-follow-row" data-author-id="{{ author.id }}">
                        <span style="font-weight:500;">{{ author.user.username }}</span>
                        <button class="follow-author-btn" style="background:#23272d;color:#fff;padding:0.3rem 0.8rem;border:none;border-radius:6px;font-size:0.98rem;font-weight:600;transition:all 0.2s;">Seguir</button>
                    </div>
                {% empty %}
                    <span style="color:#888;">No hay autores.</span>
                {% endfor %}
                {% if total_autores > 6 %}
                <div style="text-align:center;margin-top:1rem;">
                    <button style="background:#eee;color:#23272d;padding:0.5rem 1.2rem;border:none;border-radius:6px;font-size:1rem;font-weight:600;">Ver mÃ¡s autores a seguir</button>
                </div>
                {% endif %}
            </div>
        </aside>
        <!-- Muro de posts -->
        <div style="flex:1;min-width:0;">
            <div id="post-bar-center" style="margin:0 auto 2rem auto;max-width:520px;position:relative;">
                <div id="post-input-bar" style="background:#fff;border-radius:30px;box-shadow:0 2px 8px #0002;padding:0;display:flex;align-items:center;cursor:pointer;">
                    <button id="trigger-post-form" type="button" style="width:100%;padding:1rem 1.5rem;border:none;outline:none;background:#f3f4f6;font-size:1.15rem;color:#23272d;border-radius:30px;font-weight:600;box-shadow:none;transition:background 0.2s;cursor:pointer;">Â¿QuÃ© quieres opinar?</button>
                </div>
            </div>
            <div id="modal-bg" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:2000;justify-content:center;align-items:center;flex-direction:column;">
                <div id="post-modal" style="animation:popIn 0.18s cubic-bezier(.4,1.4,.6,1) 1;max-width:420px;width:95vw;">
                    <form id="post-form" method="post" enctype="multipart/form-data" style="background:#fff;padding:2rem 1.5rem 1.5rem 1.5rem;border-radius:18px;box-shadow:0 4px 32px #0004;display:flex;flex-direction:column;gap:0.7rem;max-height:80vh;overflow-y:auto;">
                        {% csrf_token %}
                        {% if error %}<div style="color:red;margin-bottom:1rem;">{{ error }}</div>{% endif %}
                        
                        <!-- Contenedor para la vista previa del post compartido -->
                        <div id="share-preview-container" style="display: none; border: 1px solid #eee; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.7rem;">
                        </div>

                        <div style="display:flex;flex-direction:column;gap:0.7rem;">
                            <select name="work" required style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid #ccc;">
                                <option value="">Selecciona una obra (como subreddit)</option>
                                {% for work in works_followed %}
                                    <option value="{{ work.id }}">{{ work.title }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="title" placeholder="TÃ­tulo del post" style="width:100%;padding:0.7rem;font-size:1.15rem;border-radius:6px;border:1.5px solid #bbb;font-weight:600;" required>
                            <textarea name="content" placeholder="Texto (opcional)" style="width:100%;min-height:90px;padding:0.7rem;border-radius:6px;border:1.5px solid #bbb;font-size:1.05rem;"></textarea>
                            <div style="margin-top:0.5rem;">
                                <label style="font-size:0.98rem;color:#23272d;font-weight:500;">Imagen (opcional):
                                    <input type="file" name="image" accept="image/*" style="margin-top:0.2rem;">
                                </label>
                            </div>
                        </div>
                        <div style="display:flex;gap:1rem;">
                            <button type="submit" style="flex:1;background:#23272d;color:#fff;padding:0.7rem;border:none;border-radius:6px;font-size:1.1rem;font-weight:600;">Publicar</button>
                            <button type="button" id="close-post-form" style="background:#eee;color:#23272d;padding:0.7rem 1.2rem;border:none;border-radius:6px;font-size:1.1rem;font-weight:600;">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
            <style>
            @keyframes popIn {
                0% { transform: scale(0.85); opacity: 0; }
                100% { transform: scale(1); opacity: 1; }
            }
            </style>
            <h2 style="margin-bottom:1rem;">Ãšltimos posts</h2>
            <div id="post-list">
                {% for post in posts %}
                <div class="post" style="background:#fff;padding:1.2rem 1.2rem 0.7rem 1.2rem;border-radius:12px;box-shadow:0 2px 8px #0002;margin-bottom:1.5rem;display:flex;gap:1.2rem;">
                    <div style="display:flex;flex-direction:column;align-items:center;gap:0.5rem;min-width:40px;">
                        <button class="vote-btn" data-post-id="{{ post.id }}" data-vote-type="1" style="background:none;border:none;font-size:1.5rem;color:#bbb;cursor:pointer;">â–²</button>
                        <span id="vote-count-{{ post.id }}" style="font-weight:600;font-size:1.1rem;color:#888;">{{ post.score }}</span>
                        <button class="vote-btn" data-post-id="{{ post.id }}" data-vote-type="-1" style="background:none;border:none;font-size:1.5rem;color:#bbb;cursor:pointer;">â–¼</button>
                    </div>
                    <div style="flex:1;min-width:0;">
                        <div style="display:flex;align-items:center;gap:0.7rem;margin-bottom:0.2rem;">
                            <span style="font-size:0.97rem;color:#888;">Publicado por <b>{{ post.user.username }}</b> en <span style="color:#3b82f6;font-weight:600;">{{ post.work.title }}</span> â€¢ {{ post.created_at|date:"d M Y H:i" }}</span>
                        </div>
                        <h2 style="margin:0 0 0.5rem 0;font-size:1.35rem;font-weight:700;line-height:1.2;"><a href="{% url 'post_detail' post.id %}" style="color:#23272d;text-decoration:none;">{{ post.title }}</a></h2>
                        {% if post.content %}<div style="margin-bottom:0.7rem;font-size:1.08rem;white-space:pre-line;">{{ post.content|linebreaksbr }}</div>{% endif %}
                        {% if post.image %}<img src="{{ post.image.url }}" alt="Imagen del post" style="max-width:100%;border-radius:8px;margin-bottom:0.7rem;" />{% endif %}
                        
                        {% if post.shared_post %}
                        <a href="{% url 'post_detail' post.shared_post.id %}" style="text-decoration: none; color: inherit; display: block; margin-bottom: 0.7rem;">
                            <div class="shared-post" style="border: 1px solid #eee; border-radius: 8px; padding: 0.8rem;">
                                <div style="display:flex;align-items:center;gap:0.7rem;margin-bottom:0.2rem;">
                                    <span style="font-size:0.9rem;color:#888;">Compartido de <b>{{ post.shared_post.user.username }}</b> en <span style="color:#3b82f6;font-weight:600;">{{ post.shared_post.work.title }}</span></span>
                                </div>
                                <h3 style="margin:0 0 0.5rem 0;font-size:1.1rem;font-weight:700; color: #23272d;">{{ post.shared_post.title }}</h3>
                                {% if post.shared_post.content %}
                                    <p style="font-size:1rem;white-space:pre-line;margin:0;">{{ post.shared_post.content|truncatewords:30|linebreaksbr }}</p>
                                {% endif %}
                                {% if post.shared_post.image and not post.shared_post.content %}
                                    <img src="{{ post.shared_post.image.url }}" alt="Imagen del post compartido" style="max-width:100%;border-radius:8px;margin-top:0.5rem;" />
                                {% endif %}
                            </div>
                        </a>
                        {% endif %}

                        <div style="display:flex;gap:1.5rem;margin-top:0.5rem;">
                            <a href="{% url 'post_detail' post.id %}" style="background:none;border:none;color:#888;font-size:1.05rem;cursor:pointer;display:flex;align-items:center;gap:0.3rem;text-decoration:none;"><span style="font-size:1.2rem;">ðŸ’¬</span> Comentar</a>
                            <button class="share-btn" data-post-id="{{ post.id }}" style="background:none;border:none;color:#888;font-size:1.05rem;cursor:pointer;display:flex;align-items:center;gap:0.3rem;"><span style="font-size:1.2rem;">ðŸ”—</span> Compartir</button>
                        </div>
                    </div>
                </div>
                {% empty %}
                    <p>No posts disponibles.</p>
                {% endfor %}
            </div>
        </div>
        <!-- Obras a seguir -->
        <aside style="flex:0 0 220px;background:#fff;border-radius:14px;box-shadow:0 2px 8px #0001;padding:1.2rem 1rem;min-height:300px;">
            <h3 style="margin-bottom:1rem;font-size:1.1rem;color:#23272d;">Obras a seguir</h3>
            <div style="display:flex;flex-direction:column;gap:0.7rem;">
                {% for work in works %}
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;" class="work-follow-row" data-work-id="{{ work.id }}">
                        <span style="font-weight:500;">{{ work.title }}</span>
                        <button class="follow-work-btn" style="background:#23272d;color:#fff;padding:0.3rem 0.8rem;border:none;border-radius:6px;font-size:0.98rem;font-weight:600;transition:all 0.2s;">Seguir</button>
                    </div>
                {% empty %}
                    <span style="color:#888;">No hay obras.</span>
                {% endfor %}
                {% if total_obras > 6 %}
                <div style="text-align:center;margin-top:1rem;">
                    <button style="background:#eee;color:#23272d;padding:0.5rem 1.2rem;border:none;border-radius:6px;font-size:1rem;font-weight:600;">Ver mÃ¡s obras a seguir</button>
                </div>
                {% endif %}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Follow buttons (author and work)
    // ... (tu cÃ³digo existente para seguir autores y obras) ...

    // Vote buttons
    document.querySelectorAll('.vote-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const voteType = this.getAttribute('data-vote-type');
            
            fetch("{% url 'vote' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `post_id=${postId}&vote_type=${voteType}`
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    document.getElementById(`vote-count-${data.postId}`).textContent = data.score;
                }
            });
        });
    });

    // Share button
    document.querySelectorAll('.share-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const postElement = this.closest('.post');
            const modalBg = document.getElementById('modal-bg');
            const postForm = document.getElementById('post-form');
            
            // Limpiar y preparar el formulario para compartir
            postForm.reset();
            const originalTitle = postElement.querySelector('h2 a').textContent;
            const originalAuthor = postElement.querySelector('b').textContent;
            const sharePreviewContainer = document.getElementById('share-preview-container');
            sharePreviewContainer.style.display = 'block';
            sharePreviewContainer.innerHTML = `<span style="font-size:0.9rem;color:#888;">Compartiendo el post de <b>${originalAuthor}</b></span><h4 style="margin:0.2rem 0 0 0;font-size:1rem;">${originalTitle}</h4>`;

            // AÃ±adir el ID del post a compartir
            let sharedPostInput = postForm.querySelector('input[name="shared_post_id"]');
            if (!sharedPostInput) {
                sharedPostInput = document.createElement('input');
                sharedPostInput.type = 'hidden';
                sharedPostInput.name = 'shared_post_id';
                postForm.appendChild(sharedPostInput);
            }
            sharedPostInput.value = postId;

            // Mostrar el selector de obra, ocultar contenido e imagen
            postForm.querySelector('select[name="work"]').style.display = 'block';
            postForm.querySelector('textarea[name="content"]').style.display = 'none';
            postForm.querySelector('input[name="image"]').parentElement.parentElement.style.display = 'none';
            modalBg.style.display = 'flex';
        });
    });

});
</script>
            </div>
        </aside>
    </div>
{% endblock %}